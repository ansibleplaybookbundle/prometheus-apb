---
- name: "[PROMETHEUS APB][PROMETHEUS] Creating Openshift ConfigMap resource"
  k8s_v1_config_map:
    state: "{{ state }}"
    name: "{{ prometheus_configmap_name }}"
    namespace: "{{ namespace }}"
    labels:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    resource_definition:
      kind: 'ConfigMap'
      apiVersion: 'v1'
      metadata:
        name: "{{ prometheus_configmap_name }}"
        namespace: "{{ namespace }}"
      data:
        prometheus.yml: "{{ lookup('file', 'prometheus-config-map.yml.j2') }}"
  register: prometheus_cm

- name: "[PROMETHEUS APB][PROMETHEUS] Create Prometheus PVC"
  k8s_v1_persistent_volume_claim:
    name: "{{ prometheus_pvc_name }}"
    namespace: "{{ namespace }}"
    labels:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    access_modes:
      - ReadWriteOnce
    resources_requests:
      storage: "{{ PROMETHEUS_STORAGE_SIZE }}Gi"
    state: "{{ state }}"
  register: prometheus_pvc

- name: "[PROMETHEUS APB][PROMETHEUS] Set to {{ state }} the prometheus Deployment Config"
  openshift_v1_deployment_config:
    name: "{{ service_name }}"
    namespace: "{{ namespace }}"
    labels:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    replicas: 1
    selector:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    spec_template_metadata_labels:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
      #    spec_template_spec_service_account_name: "{{ proxy_serviceaccount_name }}"
    containers:
      - env:
        image: "{{ prometheus_image }}:{{ prometheus_version }}"
        name: "{{ service_name }}"
        ports:
        - container_port: "{{ prometheus_port }}"
          protocol: TCP
        volume_mounts:
          - mount_path: "/etc/{{ service_name }}"
            name: "{{ prometheus_configmap_volume_name }}"
          - mount_path: "/{{ service_name }}"
            name: "{{ prometheus_data_volume_name }}"
    volumes:
      - name: "{{ prometheus_configmap_volume_name }}"
        config_map:
          defaultMode: 420
          name: "{{ prometheus_configmap_name }}"
      - name: "{{ prometheus_data_volume_name }}"
        persistent_volume_claim:
          claim_name: "{{ prometheus_pvc_name }}"
  register: prometheus_dc

- name: "[PROMETHEUS APB][PROMETHEUS] Set to {{ state }} the Prometheus Service"
  k8s_v1_service:
    name: "{{ service_name }}"
    namespace: "{{ namespace }}"
    labels:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    selector:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    ports:
    - name: "{{ service_name }}-{{ prometheus_port }}"
      port: "{{ prometheus_port }}"
      target_port: "{{ prometheus_port }}"
    state: "{{ state }}"
  register: prometheus_svc

- name: "[PROMETHEUS APB][PROMETHEUS] Set to {{ state }} the Prometheus Route"
  openshift_v1_route:
    name: "{{ service_name }}"
    namespace: '{{ namespace }}'
    labels:
      app: "{{ service_name }}"
      service: "{{ service_name }}"
    to_name: "{{ service_name }}"
    port_target_port: "{{ service_name }}-{{ prometheus_port }}"
  register: prometheus_route

- name: "[PROMETHEUS APB][PROMETHEUS] Rendering {{ item.res_name }} template"
  template:
    src: "{{ item.temp_src }}"
    dest: "{{ item.temp_dest }}"
  with_items:
    - { res_name: 'Prometheus Secret', temp_src: 'secret.yml.j2', temp_dest: '/tmp/prometheus-secret.yml' }

- name: "[PROMETHEUS APB][PROMETHEUS] Creating Openshift {{ item.res_name }} resource"
  shell: "oc create -f {{ item.temp_dest }} -n {{ namespace }}"
  with_items:
    - { res_name: 'secret', temp_dest: '/tmp/prometheus-secret.yml' }

  #- name: "[PROMETHEUS APB][PROMETHEUS] Entering Production mode" 
  #  include_tasks: prod.yml
  #  when: _apb_plan_id == "prod"
